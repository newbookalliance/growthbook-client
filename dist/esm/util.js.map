{"version":3,"file":"util.js","names":["hashFnv32a","str","hval","l","length","i","charCodeAt","hash","getEqualWeights","n","Array","fill","inNamespace","hashValue","namespace","chooseVariation","ranges","getUrlRegExp","regexString","escaped","replace","RegExp","e","console","error","undefined","getBucketRanges","numVariations","coverage","weights","process","env","NODE_ENV","equal","totalWeight","reduce","w","sum","cumulative","map","start","getQueryStringOverride","id","url","search","split","match","kv","filter","k","v","parseInt","isIncluded","include"],"sources":["../../src/util.ts"],"sourcesContent":["import { VariationRange } from \"./types/growthbook\";\n\nfunction hashFnv32a(str: string): number {\n  let hval = 0x811c9dc5;\n  const l = str.length;\n\n  for (let i = 0; i < l; i++) {\n    hval ^= str.charCodeAt(i);\n    hval +=\n      (hval << 1) + (hval << 4) + (hval << 7) + (hval << 8) + (hval << 24);\n  }\n  return hval >>> 0;\n}\n\nexport function hash(str: string): number {\n  return (hashFnv32a(str) % 1000) / 1000;\n}\n\nexport function getEqualWeights(n: number): number[] {\n  if (n <= 0) return [];\n  return new Array(n).fill(1 / n);\n}\n\nexport function inNamespace(\n  hashValue: string,\n  namespace: [string, number, number]\n): boolean {\n  const n = hash(hashValue + \"__\" + namespace[0]);\n  return n >= namespace[1] && n < namespace[2];\n}\n\nexport function chooseVariation(n: number, ranges: VariationRange[]): number {\n  for (let i = 0; i < ranges.length; i++) {\n    if (n >= ranges[i][0] && n < ranges[i][1]) {\n      return i;\n    }\n  }\n  return -1;\n}\n\nexport function getUrlRegExp(regexString: string): RegExp | undefined {\n  try {\n    const escaped = regexString.replace(/([^\\\\])\\//g, \"$1\\\\/\");\n    return new RegExp(escaped);\n  } catch (e) {\n    console.error(e);\n    return undefined;\n  }\n}\n\nexport function getBucketRanges(\n  numVariations: number,\n  coverage: number = 1,\n  weights?: number[]\n): VariationRange[] {\n  // Make sure coverage is within bounds\n  if (coverage < 0) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\"Experiment.coverage must be greater than or equal to 0\");\n    }\n    coverage = 0;\n  } else if (coverage > 1) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\"Experiment.coverage must be less than or equal to 1\");\n    }\n    coverage = 1;\n  }\n\n  // Default to equal weights if missing or invalid\n  const equal = getEqualWeights(numVariations);\n  weights = weights || equal;\n  if (weights.length !== numVariations) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\n        \"Experiment.weights array must be the same length as Experiment.variations\"\n      );\n    }\n    weights = equal;\n  }\n\n  // If weights don't add up to 1 (or close to it), default to equal weights\n  const totalWeight = weights.reduce((w, sum) => sum + w, 0);\n  if (totalWeight < 0.99 || totalWeight > 1.01) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\"Experiment.weights must add up to 1\");\n    }\n    weights = equal;\n  }\n\n  // Covert weights to ranges\n  let cumulative = 0;\n  return weights.map((w) => {\n    const start = cumulative;\n    cumulative += w;\n    return [start, start + coverage * w];\n  }) as VariationRange[];\n}\n\nexport function getQueryStringOverride(\n  id: string,\n  url: string,\n  numVariations: number\n) {\n  if (!url) {\n    return null;\n  }\n\n  const search = url.split(\"?\")[1];\n  if (!search) {\n    return null;\n  }\n\n  const match = search\n    .replace(/#.*/, \"\") // Get rid of anchor\n    .split(\"&\") // Split into key/value pairs\n    .map((kv) => kv.split(\"=\", 2))\n    .filter(([k]) => k === id) // Look for key that matches the experiment id\n    .map(([, v]) => parseInt(v)); // Parse the value into an integer\n\n  if (match.length > 0 && match[0] >= 0 && match[0] < numVariations)\n    return match[0];\n\n  return null;\n}\n\nexport function isIncluded(include: () => boolean) {\n  try {\n    return include();\n  } catch (e) {\n    console.error(e);\n    return false;\n  }\n}\n"],"mappings":"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"}