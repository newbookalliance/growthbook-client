const t={staleTTL:6e4,cacheKey:"gbFeaturesCache",backgroundSync:!0},e={fetch:globalThis.fetch?globalThis.fetch.bind(globalThis):void 0,SubtleCrypto:globalThis.crypto?globalThis.crypto.subtle:void 0,EventSource:globalThis.EventSource};try{globalThis.localStorage&&(e.localStorage=globalThis.localStorage)}catch(t){}const n=new Map;let r=!1;const i=new Map,s=new Map,o=new Map,u=new Set;function c(t){Object.assign(e,t)}function h(e){Object.assign(t,e),t.backgroundSync||v()}async function a(){i.clear(),s.clear(),v(),r=!1,await f()}async function f(){try{if(!e.localStorage)return;await e.localStorage.setItem(t.cacheKey,JSON.stringify(Array.from(i.entries())))}catch(t){}}function l(t){const[e,n]=t.getApiInfo();return["".concat(e,"||").concat(n),e,n]}function d(e,r){const s=r.dateUpdated||"",o=new Date(Date.now()+t.staleTTL),u=i.get(e);if(u&&s&&u.version===s)return void(u.staleAt=o);i.set(e,{data:r,version:s,staleAt:o}),f();const c=n.get(e);c&&c.forEach((t=>w(t,r)))}async function w(t,n){await(n.encryptedFeatures?t.setEncryptedFeatures(n.encryptedFeatures,void 0,e.SubtleCrypto):t.setFeatures(n.features||t.getFeatures()))}async function y(t){const[n,r,i]=l(t),o=r+"/api/features/"+i;let c=s.get(n);return c||(c=e.fetch(o).then((t=>("enabled"===t.headers.get("x-sse-support")&&u.add(n),t.json()))).then((e=>(d(n,e),p(t),s.delete(n),e))).catch((t=>(s.delete(n),Promise.resolve({})))),s.set(n,c)),await c}function p(n){const[r,i,s]=l(n);if(t.backgroundSync&&u.has(r)&&e.EventSource){if(o.has(r))return;const t={src:new e.EventSource("".concat(i,"/sub/").concat(s)),cb:e=>{try{const n=JSON.parse(e.data);d(r,n),t.errors=0}catch(e){b(t,r)}},errors:0};o.set(r,t),t.src.addEventListener("features",t.cb),t.src.onerror=()=>{b(t,r)}}}function b(t,e){t.errors++,(t.errors>3||2===t.src.readyState)&&g(t,e)}function g(t,e){t.src.onerror=null,t.src.close(),o.delete(e)}function v(){u.clear(),o.forEach(g),n.clear()}function $(t){return function(t){let e=2166136261;const n=t.length;for(let r=0;r<n;r++)e^=t.charCodeAt(r),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24);return e>>>0}(t)%1e3/1e3}function A(t){return t<=0?[]:new Array(t).fill(1/t)}const m={};function S(t,e){if("$or"in e)return k(t,e.$or);if("$nor"in e)return!k(t,e.$nor);if("$and"in e)return function(t,e){for(let n=0;n<e.length;n++)if(!S(t,e[n]))return!1;return!0}(t,e.$and);if("$not"in e)return!S(t,e.$not);for(const[n,r]of Object.entries(e))if(!T(r,O(t,n)))return!1;return!0}function O(t,e){const n=e.split(".");let r=t;for(let t=0;t<n.length;t++){if(!r||"object"!=typeof r||!(n[t]in r))return null;r=r[n[t]]}return r}function T(t,e){if("string"==typeof t)return e+""===t;if("number"==typeof t)return 1*e===t;if("boolean"==typeof t)return!!e===t;if(Array.isArray(t)||!_(t))return JSON.stringify(e)===JSON.stringify(t);for(const n in t)if(!F(n,e,t[n]))return!1;return!0}function _(t){const e=Object.keys(t);return e.length>0&&e.filter((t=>"$"===t[0])).length===e.length}function F(t,e,n){switch(t){case"$eq":return e===n;case"$ne":return e!==n;case"$lt":return e<n;case"$lte":return e<=n;case"$gt":return e>n;case"$gte":return e>=n;case"$exists":return n?null!==e:null===e;case"$in":return n.includes(e);case"$nin":return!n.includes(e);case"$not":return!T(n,e);case"$size":return!!Array.isArray(e)&&T(n,e.length);case"$elemMatch":return function(t,e){if(!Array.isArray(t))return!1;const n=_(e)?t=>T(e,t):t=>S(t,e);for(let e=0;e<t.length;e++)if(t[e]&&n(t[e]))return!0;return!1}(e,n);case"$all":if(!Array.isArray(e))return!1;for(let t=0;t<n.length;t++){let r=!1;for(let i=0;i<e.length;i++)if(T(n[t],e[i])){r=!0;break}if(!r)return!1}return!0;case"$regex":try{return(r=n,m[r]||(m[r]=new RegExp(r.replace(/([^\\])\//g,"$1\\/"))),m[r]).test(e)}catch(t){return!1}case"$type":return function(t){if(null===t)return"null";if(Array.isArray(t))return"array";const e=typeof t;return["string","number","boolean","object","undefined"].includes(e)?e:"unknown"}(e)===n;default:return console.error("Unknown operator: "+t),!1}var r}function k(t,e){if(!e.length)return!0;for(let n=0;n<e.length;n++)if(S(t,e[n]))return!0;return!1}const x="undefined"!=typeof window&&"undefined"!=typeof document,E=t=>Uint8Array.from(atob(t),(t=>t.charCodeAt(0)));class V{constructor(t){this.t=this.context=t=t||{},this.i=null,this.o=new Set,this.u={},this.debug=!1,this.h=new Set,this.l=[],this.p=0,this.ready=!1,this.g=new Map,this.v=new Map,this.$={},t.features&&(this.ready=!0),x&&t.enableDevMode&&(window._growthbook=this,document.dispatchEvent(new Event("gbloaded"))),t.clientKey&&this.A({},!0,!1)}async loadFeatures(t){await this.A(t,!0,!0),t&&t.autoRefresh&&function(t){const[e]=l(t),r=n.get(e)||new Set;r.add(t),n.set(e,r)}(this)}async refreshFeatures(t){await this.A(t,!1,!0)}getApiInfo(){return[(this.t.apiHost||"https://cdn.growthbook.io").replace(/\/*$/,""),this.t.clientKey||""]}async A(n,s,o){if(n=n||{},!this.t.clientKey)throw new Error("Missing clientKey");await async function(n,s,o,u,c){const h=await async function(n,s,o,u){const[c]=l(n),h=new Date;await async function(){if(!r){r=!0;try{if(e.localStorage){const n=await e.localStorage.getItem(t.cacheKey);if(n){const t=JSON.parse(n);t&&Array.isArray(t)&&t.forEach((t=>{let[e,n]=t;i.set(e,{...n,staleAt:new Date(n.staleAt)})}))}}}catch(t){}}}();const a=i.get(c);if(a&&!u&&(s||a.staleAt>h))return a.staleAt<h?y(n):p(n),a.data;{const t=await function(t,e){return new Promise((n=>{let r,i=!1;const s=t=>{i||(i=!0,r&&clearTimeout(r),n(t||null))};e&&(r=setTimeout((()=>s()),e)),t.then((t=>s(t))).catch((()=>s()))}))}(y(n),o);return t}}(n,u,s,o);c&&h&&await w(n,h)}(this,n.timeout,n.skipCache||this.t.enableDevMode,s,o)}m(){this.i&&this.i()}setFeatures(t){this.t.features=t,this.ready=!0,this.m()}async setEncryptedFeatures(t,e,n){if(e=e||this.t.decryptionKey||"",!(n=n||globalThis.crypto&&globalThis.crypto.subtle))throw new Error("No SubtleCrypto implementation found");try{const r=await n.importKey("raw",E(e),{name:"AES-CBC",length:128},!0,["encrypt","decrypt"]),[i,s]=t.split("."),o=await n.decrypt({name:"AES-CBC",iv:E(i)},r,E(s));this.setFeatures(JSON.parse((new TextDecoder).decode(o)))}catch(t){throw new Error("Failed to decrypt features")}}setAttributes(t){this.t.attributes=t,this.m()}setAttributeOverrides(t){this.$=t,this.m()}setForcedVariations(t){this.t.forcedVariations=t||{},this.m()}setForcedFeatures(t){this.v=t,this.m()}getAttributes(){return{...this.t.attributes,...this.$}}getFeatures(){return this.t.features||{}}subscribe(t){return this.h.add(t),()=>{this.h.delete(t)}}getAllResults(){return new Map(this.g)}destroy(){var t;this.h.clear(),this.g.clear(),this.o.clear(),this.u={},this.l=[],this.p&&clearTimeout(this.p),t=this,n.forEach((e=>e.delete(t))),x&&window._growthbook===this&&delete window._growthbook}setRenderer(t){this.i=t}forceVariation(t,e){this.t.forcedVariations=this.t.forcedVariations||{},this.t.forcedVariations[t]=e,this.m()}run(t){const e=this.S(t,null);return this.O(t,e),e}O(t,e){const n=t.key,r=this.g.get(n);r&&r.result.inExperiment===e.inExperiment&&r.result.variationId===e.variationId||(this.g.set(n,{experiment:t,result:e}),this.h.forEach((n=>{try{n(t,e)}catch(t){console.error(t)}})))}T(t,e){if("override"===e.source)return;const n=JSON.stringify(e.value);if(this.u[t]!==n){if(this.u[t]=n,this.t.onFeatureUsage)try{this.t.onFeatureUsage(t,e)}catch(t){}x&&window.fetch&&(this.l.push({key:t,on:e.on}),this.p||(this.p=window.setTimeout((()=>{this.p=0;const t=[...this.l];this.l=[],this.t.realtimeKey&&window.fetch("https://rt.growthbook.io/?key=".concat(this.t.realtimeKey,"&events=").concat(encodeURIComponent(JSON.stringify(t))),{cache:"no-cache",mode:"no-cors"}).catch((()=>{}))}),this.t.realtimeInterval||2e3)))}}_(t,e,n,r,i,s){const o={value:e,on:!!e,off:!e,source:n,ruleId:r||""};return i&&(o.experiment=i),s&&(o.experimentResult=s),this.T(t,o),o}isOn(t){return this.evalFeature(t).on}isOff(t){return this.evalFeature(t).off}getFeatureValue(t,e){var n;return null!==(n=this.evalFeature(t).value)&&void 0!==n?n:e}feature(t){return this.evalFeature(t)}evalFeature(t){var e;if(this.v.has(t))return this._(t,this.v.get(t),"override");if(!this.t.features||!this.t.features[t])return this._(t,null,"unknownFeature");const n=this.t.features[t];if(n.rules)for(const e of n.rules){if(e.condition&&!this.F(e.condition))continue;if("force"in e){if("coverage"in e){const{hashValue:n}=this.k(e.hashAttribute);if(!n)continue;if($(n+t)>e.coverage)continue}return this._(t,e.force,"force",e.id)}if(!e.variations)continue;const n={variations:e.variations,key:e.key||t};"coverage"in e&&(n.coverage=e.coverage),e.weights&&(n.weights=e.weights),e.hashAttribute&&(n.hashAttribute=e.hashAttribute),e.namespace&&(n.namespace=e.namespace);const r=this.S(n,t);if(this.O(n,r),r.inExperiment)return this._(t,r.value,"experiment",e.id,n,r)}return this._(t,null!==(e=n.defaultValue)&&void 0!==e?e:null,"defaultValue")}F(t){return S(this.getAttributes(),t)}S(t,e){var n;const r=t.key,i=t.variations.length;if(i<2)return this.V(t,-1,!1,e);if(!1===this.t.enabled)return this.V(t,-1,!1,e);t=this.C(t);const s=function(t,e,n){if(!e)return null;const r=e.split("?")[1];if(!r)return null;const i=r.replace(/#.*/,"").split("&").map((t=>t.split("=",2))).filter((e=>{let[n]=e;return n===t})).map((t=>{let[,e]=t;return parseInt(e)}));return i.length>0&&i[0]>=0&&i[0]<n?i[0]:null}(r,this.M(),i);if(null!==s)return this.V(t,s,!1,e);if(this.t.forcedVariations&&r in this.t.forcedVariations)return this.V(t,this.t.forcedVariations[r],!1,e);if("draft"===t.status||!1===t.active)return this.V(t,-1,!1,e);const{hashValue:o}=this.k(t.hashAttribute);if(!o)return this.V(t,-1,!1,e);if(t.namespace&&!function(t,e){const n=$(t+"__"+e[0]);return n>=e[1]&&n<e[2]}(o,t.namespace))return this.V(t,-1,!1,e);if(t.include&&!function(t){try{return t()}catch(t){return console.error(t),!1}}(t.include))return this.V(t,-1,!1,e);if(t.condition&&!this.F(t.condition))return this.V(t,-1,!1,e);if(t.groups&&!this.N(t.groups))return this.V(t,-1,!1,e);if(t.url&&!this.J(t.url))return this.V(t,-1,!1,e);const u=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2?arguments[2]:void 0;e<0?e=0:e>1&&(e=1);const r=A(t);n=n||r,n.length!==t&&(n=r);const i=n.reduce(((t,e)=>e+t),0);(i<.99||i>1.01)&&(n=r);let s=0;return n.map((t=>{const n=s;return s+=t,[n,n+e*t]}))}(i,null!==(n=t.coverage)&&void 0!==n?n:1,t.weights),c=function(t,e){for(let n=0;n<e.length;n++)if(t>=e[n][0]&&t<e[n][1])return n;return-1}($(o+r),u);if(c<0)return this.V(t,-1,!1,e);var h;if("force"in t)return this.V(t,null!==(h=t.force)&&void 0!==h?h:-1,!1,e);if(this.t.qaMode)return this.V(t,-1,!1,e);if("stopped"===t.status)return this.V(t,-1,!1,e);const a=this.V(t,c,!0,e);return this.j(t,a),a}log(t,e){this.debug&&(this.t.log?this.t.log(t,e):console.log(t,e))}j(t,e){if(!this.t.trackingCallback)return;const n=e.hashAttribute+e.hashValue+t.key+e.variationId;if(!this.o.has(n)){this.o.add(n);try{this.t.trackingCallback(t,e)}catch(t){console.error(t)}}}C(t){const e=t.key,n=this.t.overrides;return n&&n[e]&&"string"==typeof(t=Object.assign({},t,n[e])).url&&(t.url=function(t){try{const e=t.replace(/([^\\])\//g,"$1\\/");return new RegExp(e)}catch(t){return void console.error(t)}}(t.url)),t}k(t){const e=t||"id";let n="";return this.$[e]?n=this.$[e]:this.t.attributes?n=this.t.attributes[e]||"":this.t.user&&(n=this.t.user[e]||""),{hashAttribute:e,hashValue:n}}V(t,e,n,r){let i=!0;(e<0||e>=t.variations.length)&&(e=0,i=!1);const{hashAttribute:s,hashValue:o}=this.k(t.hashAttribute);return{featureId:r,inExperiment:i,hashUsed:n,variationId:e,value:t.variations[e],hashAttribute:s,hashValue:o}}M(){return this.t.url||(x?window.location.href:"")}J(t){const e=this.M();if(!e)return!1;const n=e.replace(/^https?:\/\//,"").replace(/^[^/]*\//,"/");return!!t.test(e)||!!t.test(n)}N(t){const e=this.t.groups||{};for(let n=0;n<t.length;n++)if(e[t[n]])return!0;return!1}}export{V as GrowthBook,a as clearCache,h as configureCache,c as setPolyfills};
//# sourceMappingURL=esm.min.js.map
